var AOI = 
    /* color: #d63000 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[61.18963976917058, 41.42651218497688],
          [61.18963976917058, 41.073400126772206],
          [61.874225340459645, 41.073400126772206],
          [61.874225340459645, 41.42651218497688]]], null, false),
    Train_Water = 
    /* color: #98ff00 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[61.497953893979044, 41.187190110409716],
                  [61.51649332268998, 41.17866328879288],
                  [61.524389746029826, 41.19158228219289],
                  [61.499670507748576, 41.192615691556774]]]),
            {
              "Class": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.36594629510209, 41.21276391355615],
                  [61.36680460198686, 41.21560483037924],
                  [61.35701990350053, 41.21637960446382],
                  [61.35598993523881, 41.214055254679515]]]),
            {
              "Class": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.42791605218217, 41.19997826109385],
                  [61.42843103631303, 41.20540278240741],
                  [61.422766210873576, 41.20527363236345],
                  [61.424311163266154, 41.19881580517081]]]),
            {
              "Class": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.406286718686076, 41.254654924703736],
                  [61.407831671078654, 41.25891352367953],
                  [61.40525675042436, 41.2592361335001],
                  [61.40439844353959, 41.254203238829824]]]),
            {
              "Class": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.42731523736283, 41.26213955017621],
                  [61.423023702939005, 41.267687942986235],
                  [61.4186463378267, 41.26549444868907],
                  [61.42062044366166, 41.26155887716714]]]),
            {
              "Class": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.38852078034829, 41.28186385694933],
                  [61.389293256544576, 41.286443156923944],
                  [61.384315076612936, 41.286443156923944],
                  [61.3851733834977, 41.282250852476686]]]),
            {
              "Class": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.288835593593305, 41.25308632595756],
                  [61.291324683559125, 41.25560286479526],
                  [61.28952223910112, 41.258183829560565],
                  [61.286089011562055, 41.25469950303361]]]),
            {
              "Class": 0,
              "system:index": "6"
            })]),
    Train_Bare_soil = 
    /* color: #0b4a8b */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[61.35114867342729, 41.2425997039481],
                  [61.35338027132768, 41.24737535898773],
                  [61.34865958346147, 41.24782709207063],
                  [61.34771544588823, 41.24292239433726]]]),
            {
              "Class": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.36565405977983, 41.254860818550156],
                  [61.36917311800737, 41.255312499877185],
                  [61.3708897317769, 41.26021626753317],
                  [61.36634070528764, 41.26086147271088],
                  [61.36591155184526, 41.255312499877185]]]),
            {
              "Class": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.42908293856401, 41.221944204862],
                  [61.432430335414594, 41.22523661220194],
                  [61.42736632479448, 41.226656815172646],
                  [61.425907203090375, 41.222589787993435]]]),
            {
              "Class": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.539117152002696, 41.23090889100087],
                  [61.54194956472242, 41.23491085495002],
                  [61.53705721547926, 41.2360081248486],
                  [61.53594141652906, 41.23181258169411]]]),
            {
              "Class": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.73060541799391, 41.25904653773775],
                  [61.73335200002516, 41.272465733212236],
                  [61.72682886770094, 41.273368849234465],
                  [61.72579889943922, 41.26756288537081]]]),
            {
              "Class": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.57914297803071, 41.15641923530611],
                  [61.58806936963227, 41.15771168803687],
                  [61.588756015140085, 41.16184736551921],
                  [61.57364981396821, 41.16520741131767]]]),
            {
              "Class": 1,
              "system:index": "5"
            })]),
    Train_Urban = 
    /* color: #ffc82d */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[61.3185963297803, 41.19466957069913],
                  [61.31885382184573, 41.1957029313282],
                  [61.31722303876467, 41.19609043735842],
                  [61.316450562568384, 41.19505708284668]]]),
            {
              "Class": 2,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.29221297675672, 41.22271026920122],
                  [61.292642130199106, 41.22393685733337],
                  [61.29178382331434, 41.224259639860094],
                  [61.29101134711805, 41.223033057782345]]]),
            {
              "Class": 2,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.2897238867909, 41.22174189389827],
                  [61.29011012488905, 41.222419758115954],
                  [61.288908495250375, 41.22274254813102],
                  [61.28873683387342, 41.221838732073834]]]),
            {
              "Class": 2,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.325601114574106, 41.21493058251213],
                  [61.32551528388563, 41.21576992934116],
                  [61.324871553722055, 41.216125034372766],
                  [61.324356569591195, 41.21554395240818],
                  [61.32504321509901, 41.214833734108055]]]),
            {
              "Class": 2,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.28620482856336, 41.211088819188156],
                  [61.28650523597303, 41.211540803053815],
                  [61.28581859046522, 41.211734509468904],
                  [61.28573275977674, 41.21147623412131]]]),
            {
              "Class": 2,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.277922167125375, 41.224550142771925],
                  [61.27822257453504, 41.22503431142369],
                  [61.27650596076551, 41.22542164376403],
                  [61.2763772147328, 41.22484064439316]]]),
            {
              "Class": 2,
              "system:index": "5"
            })]),
    Train_Crop_field = 
    /* color: #00ffff */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[61.33203841620985, 41.16784536035231],
                  [61.33354045325819, 41.168103807872996],
                  [61.330107225719125, 41.17114048987923],
                  [61.32890559608045, 41.17055900847537]]]),
            {
              "Class": 3,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.32697440558973, 41.1706236177751],
                  [61.32894851142469, 41.17168966202185],
                  [61.328605188670785, 41.17198039835132],
                  [61.32555819922987, 41.17165735790558]]]),
            {
              "Class": 3,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.323369516673715, 41.16448544981624],
                  [61.328347696605356, 41.16716693076029],
                  [61.32590152198377, 41.169072976996254],
                  [61.323841585460336, 41.168233031251035],
                  [61.32208205634657, 41.165486979633584]]]),
            {
              "Class": 3,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.34753085547987, 41.17094666331805],
                  [61.34967662269178, 41.173627879847196],
                  [61.34804583961073, 41.1745323618746],
                  [61.34602881843153, 41.17217422185418]]]),
            {
              "Class": 3,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.29186965400282, 41.16568082234633],
                  [61.29350043708387, 41.16778074831285],
                  [61.291440500560434, 41.16813611374138],
                  [61.29096843177381, 41.16610081292345]]]),
            {
              "Class": 3,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.267665399852426, 41.172981813610306],
                  [61.268180383983285, 41.17401551653099],
                  [61.26551963264051, 41.1745323618746],
                  [61.264918817821176, 41.17372478923317]]]),
            {
              "Class": 3,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.25270958271594, 41.24672960792875],
                  [61.25167961445422, 41.24837520824582],
                  [61.250520900159785, 41.2484074745044],
                  [61.251765445142695, 41.24618106527966]]]),
            {
              "Class": 3,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.24747391071887, 41.25879638111579],
                  [61.246057704359, 41.26024811536313],
                  [61.24468441334338, 41.25992551054127],
                  [61.24562855091662, 41.258022109656174]]]),
            {
              "Class": 3,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.23095150318713, 41.245245305426536],
                  [61.232024386793086, 41.246342401830944],
                  [61.22983570423693, 41.24718134547613],
                  [61.22863407459826, 41.24598746089226]]]),
            {
              "Class": 3,
              "system:index": "8"
            })]),
    Train_Wetland = 
    /* color: #d63000 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[61.694994266023166, 41.23531284489307],
                  [61.694479281892306, 41.241896147506466],
                  [61.690531070222384, 41.2422833799511],
                  [61.69070273159934, 41.23673282899441]]]),
            {
              "Class": 4,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.65963202237082, 41.2067775381275],
                  [61.658087069978244, 41.213621981878525],
                  [61.656027133454806, 41.21413851461151],
                  [61.656542117585666, 41.2067775381275]]]),
            {
              "Class": 4,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.597662265290744, 41.26977101853232],
                  [61.60521536587668, 41.27415764610025],
                  [61.601095492829806, 41.277253911622374],
                  [61.590624148835666, 41.27364158756753]]]),
            {
              "Class": 4,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.54633551358176, 41.27467370055326],
                  [61.55457525967551, 41.275060738715716],
                  [61.55612021206809, 41.27957601437963],
                  [61.54599219082785, 41.28099503650515],
                  [61.546163852204806, 41.27557678602922]]]),
            {
              "Class": 4,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.742716128816134, 41.19463657489504],
                  [61.74151449917746, 41.197736609406014],
                  [61.737222964753634, 41.197736609406014],
                  [61.73962622403098, 41.19282815362992]]]),
            {
              "Class": 4,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.81221914411792, 41.13535176690206],
                  [61.81187582136401, 41.13935957489347],
                  [61.81015920759448, 41.1401998906741],
                  [61.810073376906004, 41.13515783449773]]]),
            {
              "Class": 4,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.78003263593921, 41.16165661437006],
                  [61.78140592695483, 41.165016669948606],
                  [61.777629376661864, 41.16630895314389],
                  [61.777114392531004, 41.16230279228404]]]),
            {
              "Class": 4,
              "system:index": "6"
            })]),
    Test_Water = 
    /* color: #98ff00 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[61.683711716008304, 41.221591087208],
                  [61.668948837590335, 41.23217790293425],
                  [61.66585893280518, 41.22727203071631],
                  [61.677188583684085, 41.216942675433764]]]),
            {
              "Class": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.47359819061768, 41.09467436119524],
                  [61.4801213229419, 41.1037295122655],
                  [61.47359819061768, 41.10890332379558],
                  [61.4691349948169, 41.09829657142987]]]),
            {
              "Class": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.326656051945804, 41.2270138167182],
                  [61.32802934296143, 41.22907950015106],
                  [61.322879501652835, 41.236050699917506],
                  [61.31944627411377, 41.23346886075548]]]),
            {
              "Class": 0,
              "system:index": "2"
            })]),
    Test_Bare_soil = 
    /* color: #0b4a8b */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[61.65865161333035, 41.33908440202981],
                  [61.63736560258816, 41.349909902658034],
                  [61.621572755908474, 41.33289759364555]]]),
            {
              "Class": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.7328093281741, 41.085978666188765],
                  [61.74654223833035, 41.08908384100599],
                  [61.7383024922366, 41.09788103942171],
                  [61.72456958208035, 41.09425880627283]]]),
            {
              "Class": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.44764440056294, 41.16169876172153],
                  [61.449875998463334, 41.16492958550102],
                  [61.44575612541646, 41.16454189505758],
                  [61.445584464039506, 41.16169876172153]]]),
            {
              "Class": 1,
              "system:index": "2"
            })]),
    Test_Urban = 
    /* color: #ffc82d */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[61.31349155539878, 41.20714898191061],
                  [61.313749047464206, 41.20752027695838],
                  [61.31297657126792, 41.20773013844467],
                  [61.313040944284275, 41.20731041479897]]]),
            {
              "Class": 2,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.309822293466404, 41.20527633129915],
                  [61.30999395484336, 41.20551848741247],
                  [61.30967208976157, 41.205583062224676],
                  [61.30960771674521, 41.20530861883269]]]),
            {
              "Class": 2,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.30788901803386, 41.1910830860331],
                  [61.30769589898479, 41.191228411318704],
                  [61.307288203214526, 41.19098620233016],
                  [61.30751350877178, 41.19074399244557]]]),
            {
              "Class": 2,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.283848793599084, 41.212042800557434],
                  [61.284320862385705, 41.212478635840526],
                  [61.28412774333663, 41.21262391362298],
                  [61.28363421687789, 41.2120912268434]]]),
            {
              "Class": 2,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.29938880103803, 41.219036042160226],
                  [61.2995819200871, 41.21992375679589],
                  [61.299195681988955, 41.220052877920956],
                  [61.29880944389081, 41.21913288434235]]]),
            {
              "Class": 2,
              "system:index": "4"
            })]),
    Test_Crop_field = 
    /* color: #00ffff */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[61.33328613664199, 41.18525106641483],
                  [61.332384914412984, 41.18709199349969],
                  [61.33006748582412, 41.186962807322665],
                  [61.330367893233785, 41.18531566122379]]]),
            {
              "Class": 3,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.335603565230855, 41.17514119352711],
                  [61.33573231126357, 41.17559342565448],
                  [61.332127422347554, 41.17517349592545],
                  [61.3325136604457, 41.174042902505356]]]),
            {
              "Class": 3,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.30084213639785, 41.17297689655121],
                  [61.3015716972499, 41.1742690227504],
                  [61.29985508348037, 41.17478586609392],
                  [61.2989967765956, 41.173106110318024]]]),
            {
              "Class": 3,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.29427608872939, 41.17866206118854],
                  [61.295177310958394, 41.17875896312698],
                  [61.29522022630263, 41.18005097527335],
                  [61.29410442735244, 41.18024477489704],
                  [61.294147342696675, 41.17888816548852]]]),
            {
              "Class": 3,
              "system:index": "3"
            })]),
    Test_Wetland = 
    /* color: #bf04c2 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[61.42613455454948, 41.164666783505815],
                  [61.42725035349967, 41.16476370614699],
                  [61.427722422286294, 41.16754209423618],
                  [61.42630621592643, 41.167768236919194],
                  [61.42600580851676, 41.16489293611222]]]),
            {
              "Class": 4,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.685205518520995, 41.188580122010954],
                  [61.687179624355956, 41.189032261347144],
                  [61.689668714321776, 41.19168044332956],
                  [61.685720502651854, 41.19155126620577],
                  [61.685205518520995, 41.18909685242603]]]),
            {
              "Class": 4,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[61.736618100918456, 41.18793420325728],
                  [61.73799139193408, 41.19006571096248],
                  [61.73593145541064, 41.19161585479952],
                  [61.73430067232959, 41.190388660621934]]]),
            {
              "Class": 4,
              "system:index": "2"
            })]);
            
var startDate = ee.Date.fromYMD(2019,4,1);
var endDate = ee.Date.fromYMD(2019,6,30);

var S2 = ee.ImageCollection("COPERNICUS/S2").filterDate(startDate,endDate).filterBounds(AOI).filterMetadata('CLOUDY_PIXEL_PERCENTAGE', 'less_than', 0.1)
var img = ee.Image(S2.median()).clip(AOI).divide(10000);
var viz = {min:0,max:0.4,bands:"B4,B3,B2"};

Map.addLayer(img,viz,"AOI");
Map.centerObject(AOI)

img = img.select(['B2', 'B3', 'B4', 'B5', 'B6', 'B7','B8','B8A','B11','B12'])

// Index -----------------------------------------------------------------------------------------

var ndvi = img.expression(
    '((NIR - RED) / (NIR + RED))', {
      'NIR': img.select('B8'),
      'RED': img.select('B4')
}).rename('NDVI');


var evi = img.expression(
    '2.5 * ((NIR - RED) / (NIR + 6 * RED - 7.5 * BLUE + 1))', {
      'NIR': img.select('B8'),
      'RED': img.select('B4'),
      'BLUE': img.select('B2')
}).rename('EVI');

var savi = img.expression(
    '((NIR - RED) / (NIR + RED + 0.428) * (1.0 + 0.428))', {
      'NIR': img.select('B8'),
      'RED': img.select('B4')
}).rename('SAVI');


var ndwi = img.expression(
    '(NIR - MIR) / (NIR + MIR)', {
      'NIR': img.select('B8'),
      'MIR': img.select('B12')
}).rename('NDWI');


img = img.addBands(ndvi)
img = img.addBands(evi)
img = img.addBands(savi)
img = img.addBands(ndwi)

//classify

var bands_idx = ['B2', 'B3', 'B4', 'B5', 'B6', 'B7','B8','B8A','B11','B12','NDVI','EVI','SAVI','NDWI'];
var TrainingImage = img.select(bands_idx).float(); 

var predictionBands = TrainingImage.bandNames();

var merged = Train_Water.merge(Train_Bare_soil).merge(Train_Urban).merge(Train_Crop_field).merge(Train_Wetland)

var classifierTraining = TrainingImage.select(predictionBands).sampleRegions({collection: merged, properties: ['Class'], scale: 20 });

var RF = ee.Classifier.smileRandomForest(100).train({features:classifierTraining, classProperty:'Class', inputProperties: predictionBands});

var classified_RF = TrainingImage.select(predictionBands).classify(RF);
print('RF train error matrix: ', RF.confusionMatrix());
print('RF train accuracy: ', RF.confusionMatrix().accuracy());
print('RF train Kappa: ', RF.confusionMatrix().kappa());

Map.addLayer(classified_RF, {min: 0, max: 4,
palette: [ '172BD1' //0
,'D1D117' //1
,'FF333C' //2
,'26902E'//3
, '33FFC1']}, //4
'Random_Forest'); 

//predict

var merged_test = Test_Water.merge(Test_Bare_soil).merge(Test_Urban).merge(Test_Crop_field).merge(Test_Wetland)
var classifierTest = TrainingImage.select(predictionBands).sampleRegions({collection: merged_test, properties: ['Class'], scale: 20 });
var classified_test_RF = classifierTest.classify(RF);
var testAccuracy = classified_test_RF.errorMatrix('Class', 'classification');
print('RF test error matrix: ', testAccuracy);  
print('RF test accuracy: ', testAccuracy.accuracy());
print('RF test Kappa: ', testAccuracy.kappa());

//Export Image classified

Export.image.toDrive({
  image: classified_RF,
  description: 'RF_classifier',
  folder:"GEE_Maps",
  scale: 20,
  maxPixels: 1e9,
  region: AOI
});

